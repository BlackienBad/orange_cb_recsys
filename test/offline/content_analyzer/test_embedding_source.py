from unittest import TestCase
import numpy as np

from offline.content_analyzer.embedding_source import GensimDownloader, BinaryFile


class TestGensimDownloader(TestCase):
    def test_load(self):
        source = GensimDownloader('glove-twitter-25')
        result = source.load("title plot")

        expected = np.ndarray(shape=(2, 25))
        expected[0, :] = [8.50130022e-01, 4.52620000e-01, -7.05750007e-03,
                          -8.77380013e-01, 4.24479991e-01, -8.36589992e-01,
                          8.04159999e-01, 3.74080002e-01, 4.30849999e-01,
                          -6.39360011e-01, 1.19390003e-01, 1.13419998e+00,
                          -3.20650005e+00, 9.31460023e-01, 3.65420014e-01,
                          -3.19309998e-03, 1.97899997e-01, -3.29540014e-01,
                          2.96719998e-01, 4.88689989e-01, -1.37870002e+00,
                          7.52340019e-01, 2.03339994e-01, -6.79979980e-01,
                          -8.91939998e-01]
        expected[1, :] = [7.26029992e-01, 1.46909997e-01, 1.05829999e-01,
                          2.84680009e-01, 2.31950000e-01, -7.86419988e-01,
                          1.33580005e+00, -8.31910014e-01, 4.39669997e-01,
                          -3.01629990e-01, 2.93879986e-01, 4.53700006e-01,
                          -2.18440008e+00, 2.45710000e-01, 3.21599990e-01,
                          6.92149997e-01, 6.65279984e-01, 5.34259975e-01,
                          3.30240000e-03, -4.91389990e-01, -2.80680005e-02,
                          6.41950011e-01, -9.63369980e-02, -9.50479984e-01,
                          -3.88559997e-01]

        self.assertTrue(np.allclose(result, expected))


class TestBinaryFile(TestCase):
    def test_load(self):
        source = BinaryFile('../../../datasets/word2vec/google_news.bin')
        result = source.load("text news")
        expected = np.ndarray(shape=(2, 300))
        expected[0, :] = [0.27929688, -0.08447266, -0.04150391, 0.12011719, -0.01794434,
                          0.12353516, 0.1328125, -0.08251953, 0.11572266, 0.10693359,
                          -0.08056641, -0.01397705, -0.13671875, 0.11230469, -0.0546875,
                          0.109375, 0.12060547, 0.06396484, -0.02001953, -0.41992188,
                          0.18652344, 0.14550781, -0.08837891, -0.23828125, -0.21386719,
                          -0.24902344, -0.06884766, 0.10693359, 0.20996094, 0.04589844,
                          -0.15527344, -0.29882812, -0.11376953, -0.02416992, 0.01477051,
                          0.01489258, -0.06835938, 0.33203125, -0.10888672, -0.14160156,
                          0.05639648, 0.05078125, 0.19921875, 0.40820312, 0.04833984,
                          0.07714844, 0.06689453, -0.171875, -0.28515625, -0.203125,
                          -0.2109375, -0.18164062, 0.03369141, -0.21777344, 0.25976562,
                          0.15234375, 0.13964844, -0.22167969, -0.1484375, 0.03808594,
                          0.02990723, -0.10644531, -0.10595703, 0.11181641, -0.02770996,
                          0.19726562, -0.28320312, 0.08886719, 0.06347656, 0.21386719,
                          0.16308594, 0.08300781, -0.03088379, 0.09716797, 0.10253906,
                          -0.17089844, 0.22265625, 0.38085938, 0.23535156, -0.10839844,
                          0.08642578, 0.06494141, 0.21972656, 0.02978516, 0.359375,
                          0.00282288, 0.03564453, -0.15332031, 0.07666016, 0.13378906,
                          -0.03369141, -0.10839844, -0.01031494, -0.22070312, -0.05810547,
                          -0.078125, -0.09570312, -0.03613281, 0.14160156, 0.17578125,
                          -0.19433594, 0.06152344, -0.08300781, 0.05273438, 0.06982422,
                          0.32226562, 0.02722168, -0.01245117, -0.08300781, 0.19824219,
                          -0.08544922, 0.14550781, 0.04541016, -0.10400391, 0.34570312,
                          0.02416992, 0.12158203, -0.25585938, 0.28710938, 0.17675781,
                          0.10791016, -0.23144531, -0.34179688, 0.20605469, 0.09814453,
                          -0.17089844, -0.31640625, -0.10253906, -0.14648438, 0.10839844,
                          -0.296875, -0.11474609, -0.11767578, 0.00897217, 0.05151367,
                          0.05200195, -0.05322266, 0.10449219, 0.16015625, -0.2578125,
                          0.15527344, -0.33789062, -0.02099609, -0.18066406, 0.06982422,
                          -0.08447266, 0.02819824, 0.12695312, -0.08642578, -0.06396484,
                          0.23339844, 0.1875, 0.05175781, -0.03564453, 0.27734375,
                          -0.48046875, -0.22363281, 0.125, -0.23535156, 0.0625,
                          -0.11132812, 0.41796875, 0.17285156, -0.01159668, 0.125,
                          -0.06176758, 0.03637695, -0.1875, -0.30078125, -0.14746094,
                          -0.03088379, 0.11035156, -0.22558594, -0.16601562, 0.11425781,
                          -0.23632812, 0.02148438, -0.12988281, -0.23242188, -0.16992188,
                          -0.22558594, -0.2734375, 0.00686646, 0.04370117, 0.203125,
                          0.06640625, -0.20605469, 0.25585938, 0.01251221, 0.11279297,
                          0.06738281, 0.02929688, -0.19140625, -0.17480469, -0.00854492,
                          0.28710938, 0.11621094, -0.4921875, 0.08398438, 0.03491211,
                          -0.06835938, -0.12695312, -0.2109375, -0.03637695, -0.02185059,
                          0.06933594, 0.0859375, -0.06542969, 0.02160645, -0.0378418,
                          0.17773438, 0.00854492, 0.08007812, -0.12597656, -0.12011719,
                          0.04492188, 0.03320312, -0.05249023, -0.11523438, 0.0189209,
                          -0.21777344, 0.15234375, 0.05981445, -0.28515625, 0.06347656,
                          0.08154297, -0.10449219, 0.12060547, 0.0390625, 0.17285156,
                          0.11132812, -0.17285156, -0.04272461, -0.02478027, 0.04614258,
                          -0.16992188, 0.03320312, 0.08886719, 0.24707031, -0.00491333,
                          0.02819824, 0.05859375, 0.00193787, -0.05126953, 0.328125,
                          0.13671875, 0.10644531, 0.39648438, -0.22851562, 0.234375,
                          0.08642578, 0.16699219, -0.24121094, 0.06933594, -0.03295898,
                          -0.44335938, 0.06884766, -0.34375, -0.03491211, -0.02880859,
                          0.17578125, 0.06591797, -0.03015137, -0.171875, -0.04858398,
                          0.08837891, 0.296875, -0.30859375, -0.13574219, -0.44921875,
                          0.0177002, 0.234375, -0.03320312, 0.09228516, 0.05712891,
                          -0.04760742, 0.06445312, -0.03320312, -0.09228516, 0.18554688,
                          -0.0703125, 0.23632812, -0.18164062, 0.21386719, 0.28515625,
                          0.02648926, 0.09814453, 0.11767578, 0.04663086, 0.2734375,
                          -0.04394531, -0.07666016, 0.01269531, -0.23046875, 0.04077148,
                          -0.06835938, 0.11767578, -0.22070312, 0.00878906, -0.00051498]

        expected[1, :] = [-0.13867188, 0.04370117, -0.13085938, -0.16796875, -0.06054688,
                          -0.07080078, 0.00854492, -0.09960938, 0.19628906, 0.14648438,
                          -0.23046875, -0.09619141, -0.140625, 0.25585938, -0.16699219,
                          0.14257812, -0.16992188, 0.06884766, 0.23925781, -0.28515625,
                          0.17089844, 0.17089844, 0.05615234, -0.06445312, 0.13867188,
                          0.32226562, 0.05078125, 0.27148438, -0.00564575, 0.02587891,
                          -0.05639648, 0.03125, 0.171875, -0.18261719, 0.05029297,
                          -0.01062012, -0.02600098, 0.20019531, -0.07568359, 0.125,
                          0.01300049, -0.17089844, -0.09667969, 0.21972656, 0.06494141,
                          0.24804688, 0.11083984, 0.0267334, -0.10986328, 0.17578125,
                          0.328125, -0.11865234, 0.03222656, 0.30273438, 0.09179688,
                          -0.05224609, -0.27539062, -0.046875, 0.20996094, -0.20410156,
                          0.10595703, -0.08398438, -0.09765625, -0.16015625, -0.0045166,
                          0.09228516, 0.05737305, -0.04418945, 0.06445312, 0.16992188,
                          -0.06396484, 0.02160645, 0.01672363, 0.01916504, -0.14453125,
                          0.22949219, -0.14746094, 0.05859375, 0.00610352, -0.08544922,
                          0.34960938, 0.14355469, 0.07128906, -0.0534668, 0.01928711,
                          -0.25, -0.21972656, -0.2421875, 0.01611328, -0.01818848,
                          0.31054688, 0.08154297, 0.171875, 0.05664062, -0.04736328,
                          -0.07421875, 0.00244141, 0.11035156, 0.31445312, -0.05175781,
                          -0.03710938, 0.00430298, 0.08496094, -0.14453125, -0.06347656,
                          0.06298828, -0.07861328, -0.12695312, 0.15039062, -0.20214844,
                          0.05639648, 0.13769531, 0.16992188, 0.01782227, -0.07617188,
                          0.04760742, 0.16015625, 0.20214844, 0.33007812, 0.01123047,
                          -0.06787109, -0.14453125, -0.234375, 0.06542969, 0.06933594,
                          0.00680542, 0.04785156, 0.00430298, 0.19433594, -0.15625,
                          -0.34375, -0.21777344, 0.09082031, 0.05957031, 0.07666016,
                          -0.01806641, -0.00915527, 0.03295898, -0.03027344, -0.04833984,
                          0.36132812, -0.08544922, 0.00897217, -0.15917969, 0.03344727,
                          -0.31445312, 0.13378906, -0.10839844, -0.10693359, -0.16503906,
                          0.13378906, 0.12597656, -0.33398438, 0.01257324, -0.08105469,
                          -0.05151367, -0.0071106, -0.1015625, -0.18652344, -0.07373047,
                          -0.10498047, 0.203125, -0.17578125, 0.26953125, 0.00927734,
                          -0.05126953, -0.04150391, 0.01013184, 0.31640625, -0.14550781,
                          0.25, -0.13476562, 0.10693359, -0.2578125, -0.01000977,
                          -0.10351562, 0.27539062, -0.15722656, 0.06298828, -0.23828125,
                          0.09179688, -0.27148438, 0.18457031, -0.24023438, 0.25585938,
                          0.08300781, -0.18359375, 0.06542969, 0.1640625, -0.00408936,
                          0.09033203, 0.00247192, -0.14355469, -0.20507812, -0.10253906,
                          0.23046875, 0.02746582, 0.19726562, 0.06884766, 0.078125,
                          0.05444336, 0.11865234, 0.03735352, -0.16992188, 0.00372314,
                          -0.08691406, 0.15136719, 0.24023438, -0.1015625, 0.02685547,
                          0.00479126, 0.10205078, 0.078125, 0.1640625, -0.03979492,
                          0.27539062, -0.03540039, 0.00088882, -0.1953125, 0.11621094,
                          0.18652344, -0.1796875, -0.25390625, -0.12890625, 0.00653076,
                          -0.14550781, 0.06396484, 0.11132812, -0.00793457, -0.0859375,
                          0.19238281, 0.18457031, -0.06445312, -0.05395508, 0.0246582,
                          -0.13964844, 0.10791016, -0.01855469, 0.39453125, 0.33203125,
                          0.07470703, 0.00787354, -0.12988281, -0.09814453, 0.00271606,
                          0.203125, 0.16894531, 0.109375, 0.10693359, -0.0123291,
                          -0.05615234, 0.04516602, -0.16992188, -0.06591797, 0.08203125,
                          -0.02038574, -0.06884766, 0.04101562, 0.0625, -0.01586914,
                          0.12109375, 0.15917969, -0.0291748, 0.20019531, -0.03491211,
                          0.51171875, 0.19921875, -0.01275635, 0.00793457, 0.00714111,
                          0.140625, 0.15917969, 0.24511719, -0.45898438, 0.25976562,
                          0.05078125, 0.25976562, -0.08740234, 0.26171875, -0.04833984,
                          -0.25976562, -0.05541992, -0.08740234, -0.05126953, -0.10498047,
                          0.01446533, -0.08496094, 0.21386719, -0.00939941, 0.16113281,
                          0.14453125, -0.06884766, 0.00074005, -0.07226562, 0.19824219,
                          -0.04614258, -0.08740234, 0.08251953, 0.22949219, 0.05932617]

        self.assertTrue(np.allclose(result, expected))